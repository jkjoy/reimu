---
pubDate: "2024-12-27T10:48:00Z"
title: "Tianji - ä¸€ä¸ªé›†æˆ ç½‘ç«™åˆ†æ + ä¸Šçº¿ç›‘æ§ + æœåŠ¡å™¨çŠ¶æ€ çš„åº”ç”¨"
keywords:
  - åˆ†äº«
tags:
  - åˆ†äº«
  - éƒ¨ç½²
  - Tianji
description: "Tianji æ˜¯ä¸€ä¸ªé›†æˆäº†ç½‘ç«™åˆ†æã€ä¸Šçº¿ç›‘æ§å’ŒæœåŠ¡å™¨çŠ¶æ€çš„å¤šåŠŸèƒ½åº”ç”¨ï¼Œç»“åˆäº† uptime-kuma ã€ nezha  å’Œ umami  çš„åŠŸèƒ½ã€‚é¡¹ç›®é€šè¿‡ Docker Compose éƒ¨ç½²ï¼Œæ”¯æŒ PostgreSQL æ•°æ®åº“ï¼Œå¹¶æä¾›é»˜è®¤çš„ç®¡ç†å‘˜è´¦æˆ·ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ API è·å–ç½‘ç«™ç»Ÿè®¡æ•°æ®ï¼Œå¹¶ä½¿ç”¨ Cloudflare Workers ä¿æŠ¤è®¿é—®ä»¤ç‰Œã€‚Tianji è¿˜æ”¯æŒé€šè¿‡ HTML å’Œ JavaScript è°ƒç”¨ç»Ÿè®¡æ•°æ®ï¼Œå±•ç¤ºè®¿å®¢å’Œé¡µé¢æµè§ˆé‡ã€‚"
draft: "false"
---

## ç®€ä»‹

ä¸€ä¸ªAll-in-oneçš„é¡¹ç›®,é›†æˆäº†`uptime-kuma`+ `nezha` + `umami` çš„åŠŸèƒ½çš„è¶…å¼ºåº”ç”¨.
## é¡¹ç›®åœ°å€

https://github.com/msgbyte/tianji

## é¢„è§ˆ
![2025-03-16T08:08:01.png](https://img.imsun.org/usr/uploads/2025/03/1329361565.png)
 
## éƒ¨ç½²

ä½¿ç”¨ docker compose çš„æ–¹å¼æ¥éƒ¨ç½²
```
mkdir /home/tianji
cd /home/tianji
vi docker-compose.yaml
```

docker-compose.yamlçš„å†…å®¹å¦‚ä¸‹
```yaml
services:
  tianji:
    image: moonrailgun/tianji
    ports:
      - "12345:12345"
    environment:
      DATABASE_URL: postgresql://tianji:tianji@postgres:5432/tianji
      JWT_SECRET: replace-me-with-a-random-string
      ALLOW_REGISTER: "false"
      ALLOW_OPENAPI: "true"
    depends_on:
      - postgres
    restart: always
  postgres:
    image: postgres:15.4-alpine
    environment:
      POSTGRES_DB: tianji
      POSTGRES_USER: tianji
      POSTGRES_PASSWORD: tianji
    volumes:
      - ./tianji-db-data:/var/lib/postgresql/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
```
è¿è¡Œå®¹å™¨
```bash
docker compose up -d
```
é»˜è®¤å¯†ç 
```text
Url: http://<your-ip>:12345
Default username: admin
Default password: admin
```

## ç›‘æ§

https://0tz.top/status/imsun
 å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå°å¾½ç« æ˜¾ç¤ºçŠ¶æ€
![](https://0tz.top/monitor/clnzoxcy10001vy2ohi4obbi0/cm8bcu7eg0001dwpmq7cedh2q/badge.svg)

## é¥æµ‹

åœ¨é¡µé¢æ’å…¥ä¸€å¼ å›¾ç‰‡å°±å¯ä»¥ä¾¦æµ‹åˆ°è®¿é—®é‡,ä½†æ˜¯åªèƒ½æ˜¾ç¤º pv æµè§ˆé‡

![](https://0tz.top/telemetry/clnzoxcy10001vy2ohi4obbi0/cm8bcwmr40007of44gdcyf1hg/badge.svg)

## å¤šç”¨æˆ·

æ²¡é”™,Tianjiæ˜¯æ”¯æŒå¤šç”¨æˆ·ä½¿ç”¨çš„,è‹¥æ˜¯æœ‰æƒ³ä½“éªŒçš„æœ‹å‹å¯ä»¥ç•™è¨€,æˆ‘å¯ä»¥å‘é€é‚€è¯·.

## é€šçŸ¥

å¯ä»¥æ”¯æŒå¤šç§é€šçŸ¥æ–¹å¼ 

## è®¿å®¢ç»Ÿè®¡

ä»æœ¨æœ¨è€å¸ˆé‚£é‡Œå¾—åˆ°çµæ„Ÿ,ä½¿ç”¨APIè·å–ç½‘ç«™çš„ç»Ÿè®¡æ•°æ®å¹¶ä½¿ç”¨js è°ƒç”¨,æ›¿ä»£Umami.

åœ¨åå°è·å–`token` `websiteID` `workspaceID`

ç„¶åä½¿ç”¨Cloudflare Workersæ¥ä¿æŠ¤`token`.
æ–°å»ºä¸€ä¸ªworkers,å¡«å…¥ä»¥ä¸‹ä»£ç (éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†å·²ç»æ ‡æ³¨å‡ºæ¥)

```js
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

const tianji = 'https://tianji.top'; #è‡ªè¡Œä¿®æ”¹
const token = 'sk_cf38cfb0bcb22d****'; #è‡ªè¡Œä¿®æ”¹
const workspaceID = 'clnzoxcy10001vy2ohi4obbi0'; #è‡ªè¡Œä¿®æ”¹
const websiteID = 'cm3sj40cs00018n2ezrgbdl5w'; #è‡ªè¡Œä¿®æ”¹

async function handleRequest(request) {
  const url = `${tianji}/open/workspace/${workspaceID}/website/${websiteID}/stats`;

  // è·å–å½“å‰æ—¶é—´çš„ Unix æ—¶é—´æˆ³ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰
  const now = Date.now();

  // è®¾ç½®æŸ¥è¯¢å‚æ•°
  const params = new URLSearchParams({
    startAt: '1704067200000', // 2024å¹´1æœˆ1æ—¥çš„ Unix æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
    endAt: now.toString()  
  });

  const fullUrl = `${url}?${params.toString()}`;

  const headers = new Headers({
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  });

  const response = await fetch(fullUrl, {
    method: 'GET',
    headers: headers
  });

  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization'
  };

  if (request.method === 'OPTIONS') {
    return new Response(null, {
      headers: corsHeaders
    });
  }

  if (response.ok) {
    const data = await response.json();
    return new Response(JSON.stringify(data), {
      headers: {
        'Content-Type': 'application/json',
        ...corsHeaders
      }
    });
  } else {
    return new Response(`Failed to fetch data: ${response.status} ${response.statusText}`, {
      status: response.status,
      headers: corsHeaders
    });
  }
}
```
`startAt` çš„å€¼ æ˜¯æŸæ—¶é—´çš„unixæ—¶é—´æˆ³ å¯ä»¥è‡ªè¡Œè®¾ç½®æŸ¥è¯¢èŒƒå›´

## è°ƒç”¨
ä½¿ç”¨html+jsè°ƒç”¨ 
```html
ğŸ‘£<p>æœ¬ç«™åˆ°è®¿<span id="uniques">0</span>ä½æœ‹å‹.</p><p>å…±æµè§ˆé¡µé¢<span id="pageviews">0</span>æ¬¡</p>
<script>
// å®šä¹‰ API URL
const apiUrl = 'https://tj.imsun.org';

fetch(apiUrl)
    .then(response => {
        if (!response.ok) {
            throw new Error('error');
        }
        return response.json();
    })
    .then(data => {
        const pageviewsElement = document.getElementById('pageviews');
        const uniquesElement = document.getElementById('uniques');
        pageviewsElement.textContent = data.pageviews.value;
        uniquesElement.textContent = data.uniques.value;
    })
    .catch(error => {
        console.error('è·å–æ•°æ®æ—¶å‡ºç°é—®é¢˜:', error);
    });
</script>
```

## å…¶ä»– 

è¿˜æœ‰å…¶ä»–å¾ˆå¤šåŠŸèƒ½,ç­‰å¾…æ‘¸ç´¢