---
pubDate: "2025-04-07T02:52:00Z"
title: "Typecho æ‰¹é‡æ’å…¥é™„ä»¶ "
keywords:
  - Typecho
tags:
  - typecho
description: "æ–‡ç« ä»‹ç»äº†å¦‚ä½•åœ¨Typechoä¸­æ·»åŠ æ‰¹é‡æ’å…¥é™„ä»¶åŠŸèƒ½ï¼ŒåŒ…æ‹¬è‡ªåŠ¨è¯†åˆ«å›¾ç‰‡ä¸æ™®é€šæ–‡ä»¶å¹¶ä¿®æ­£Markdownæ ¼å¼ã€‚é€šè¿‡ä¿®æ”¹ä¸»é¢˜çš„functions.phpæ–‡ä»¶ï¼Œæ·»åŠ JavaScriptä»£ç å®ç°æ‰¹é‡æ’å…¥æŒ‰é’®å’Œæ ¼å¼ä¿®æ­£åŠŸèƒ½ã€‚"
draft: "false"
---

åœ¨æ–‡ç« çš„é™„ä»¶é€‰é¡¹é¡µåŠ å…¥`æ‰¹é‡æ’å…¥æ‰€æœ‰é™„ä»¶`çš„æŒ‰é’®

å¹¶è‡ªåŠ¨è¯†åˆ«å›¾ç‰‡ä¸æ™®é€šæ–‡ä»¶,å®ç°å›¾ç‰‡é¢„è§ˆåŠŸèƒ½

![2025-04-07T03:20:33.png](https://img.imsun.org/2025/04/830007048.png)

Markdownè¯­æ³•æ ¼å¼è‡ªåŠ¨ä¿®æ­£ä¸º 
```markdown
![2025-04-07T02:49:18.png](https://img.imsun.org/2025/04/750116001.png)
```

å…·ä½“ä»£ç å®ç°
åœ¨ä¸»é¢˜çš„`functions.php`æœ€åæ’å…¥
```php
/**
 * å¢å¼ºé™„ä»¶åŠŸèƒ½ï¼šå›¾ç‰‡é¢„è§ˆã€æ‰¹é‡æ’å…¥ã€ä¼˜åŒ–æ’å…¥æ ¼å¼
 * 
 * @author: jkjoy
 * @date: 2025-04-07
 */
Typecho_Plugin::factory('admin/write-post.php')->bottom = array('AttachmentHelper', 'addEnhancedFeatures');
Typecho_Plugin::factory('admin/write-page.php')->bottom = array('AttachmentHelper', 'addEnhancedFeatures');

class AttachmentHelper {
    public static function addEnhancedFeatures() {
        ?>
        <style>#file-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;padding:15px;list-style:none;margin:0;}#file-list li{position:relative;border:1px solid #e0e0e0;border-radius:4px;padding:10px;background:#fff;transition:all 0.3s ease;list-style:none;margin:0;}#file-list li:hover{box-shadow:0 2px 8px rgba(0,0,0,0.1);}#file-list li.loading{opacity:0.7;pointer-events:none;}#file-list .thumb-container{position:relative;width:100%;height:150px;margin-bottom:8px;background:#f5f5f5;overflow:hidden;border-radius:3px;display:flex;align-items:center;justify-content:center;}#file-list .thumb-container img{width:100%;height:100%;object-fit:contain;display:block;}#file-list .thumb-container .file-icon{display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:40px;color:#999;}#file-list .file-info{padding:5px 0;}#file-list .file-name{font-size:13px;margin-bottom:5px;word-break:break-all;color:#333;}#file-list .file-size{font-size:12px;color:#999;}#file-list .file-actions{display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:8px;}#file-list .file-actions button{flex:1;padding:4px 8px;border:none;border-radius:3px;background:#e0e0e0;color:#333;cursor:pointer;font-size:12px;transition:all 0.2s ease;}#file-list .file-actions button:hover{background:#d0d0d0;}#file-list .file-actions .btn-insert{background:#467B96;color:white;}#file-list .file-actions .btn-insert:hover{background:#3c6a81;}#file-list .file-checkbox{position:absolute;top:5px;right:5px;z-index:2;width:18px;height:18px;cursor:pointer;}.batch-actions{margin:15px;display:flex;gap:10px;align-items:center;}.btn-batch{padding:8px 15px;border-radius:4px;border:none;cursor:pointer;transition:all 0.3s ease;font-size:10px;display:inline-flex;align-items:center;justify-content:center;}.btn-batch.primary{background:#467B96;color:white;}.btn-batch.primary:hover{background:#3c6a81;}.btn-batch.secondary{background:#e0e0e0;color:#333;}.btn-batch.secondary:hover{background:#d0d0d0;}.upload-progress{position:absolute;bottom:0;left:0;width:100%;height:2px;background:#467B96;transition:width 0.3s ease;}</style>
        
        <script>
        $(document).ready(function() {
            // ä¿®æ”¹é»˜è®¤çš„æ–‡ä»¶åˆ—è¡¨å±•ç¤ºæ–¹å¼
            function updateFileList(newItem = null) {
                var items = newItem ? $(newItem) : $('#file-list li:not(.enhanced)');
                
                items.each(function() {
                    var $li = $(this);
                    if ($li.hasClass('enhanced')) return;
                    
                    var $title = $li.find('.insert');
                    var url = $li.data('url');
                    var isImage = $li.data('image') == 1;
                    var fileName = $title.text();
                    var fileSize = $li.find('.info').text().trim();
                    
                    // æ¸…ç©ºåŸæœ‰å†…å®¹å¹¶é‡æ–°æ„å»º
                    $li.addClass('enhanced').empty();
                    
                    // æ·»åŠ å¤é€‰æ¡†
                    $li.append('<input type="checkbox" class="file-checkbox" />');
                    
                    // æ·»åŠ é¢„è§ˆå®¹å™¨
                    var $thumbContainer = $('<div class="thumb-container"></div>');
                    if (isImage) {
                        var $img = $('<img src="' + url + '" alt="' + fileName + '" />');
                        $img.on('load', function() {
                            $(this).show();
                        }).on('error', function() {
                            $(this).replaceWith('<div class="file-icon">ğŸ–¼ï¸</div>');
                        });
                        $thumbContainer.append($img);
                    } else {
                        $thumbContainer.append('<div class="file-icon">ğŸ“„</div>');
                    }
                    $li.append($thumbContainer);
                    
                    // æ·»åŠ æ–‡ä»¶ä¿¡æ¯
                    var $fileInfo = $('<div class="file-info"></div>')
                        .append('<div class="file-name">' + fileName + '</div>')
                        .append('<div class="file-size">' + fileSize + '</div>');
                    $li.append($fileInfo);
                    
                    // æ·»åŠ æ“ä½œæŒ‰é’®
                    var $actions = $('<div class="file-actions"></div>')
                        .append('<button type="button" class="btn-insert">æ’å…¥</button>')
                        .append('<button type="button" class="btn-delete">åˆ é™¤</button>');
                    $li.append($actions);
                });
            }
            
            // æ·»åŠ æ‰¹é‡æ“ä½œæŒ‰é’®
            var $batchActions = $('<div class="batch-actions"></div>')
                .append('<button type="button" class="btn-batch primary" id="batch-insert">æ‰¹é‡æ’å…¥é€‰ä¸­</button>')
                .append('<button type="button" class="btn-batch secondary" id="select-all">å…¨é€‰</button>')
                .append('<button type="button" class="btn-batch secondary" id="unselect-all">å–æ¶ˆå…¨é€‰</button>');
            $('#file-list').before($batchActions);
            
            // ä¿®æ”¹æ’å…¥æ ¼å¼
            Typecho.insertFileToEditor = function(title, url, isImage) {
                var textarea = $('#text'), 
                    sel = textarea.getSelection(),
                    insertContent = isImage ? '![' + title + '](' + url + ')' : 
                                            '[' + title + '](' + url + ')';
                
                textarea.replaceSelection(insertContent + '\n');
                textarea.focus();
            };
            
            // ä¿®æ”¹ Typecho çš„é»˜è®¤ä¸Šä¼ å®Œæˆå›è°ƒ
            var originalUploadComplete = Typecho.uploadComplete;
            Typecho.uploadComplete = function(attachment) {
                // æ„å»ºæ–°çš„åˆ—è¡¨é¡¹
                var newLi = $('<li></li>')
                    .attr({
                        'id': 'file-' + attachment.cid,
                        'data-cid': attachment.cid,
                        'data-url': attachment.url,
                        'data-image': attachment.isImage ? 1 : 0
                    })
                    .append('<input type="hidden" name="attachment[]" value="' + attachment.cid + '" />')
                    .append('<a class="insert" title="ç‚¹å‡»æ’å…¥æ–‡ä»¶" href="###">' + attachment.title + '</a>')
                    .append('<div class="info">' + attachment.bytes + '</div>');

                // æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
                $('#file-list').prepend(newLi);
                
                // ç«‹å³æ›´æ–°è¿™ä¸ªæ–°é¡¹ç›®çš„é¢„è§ˆ
                updateFileList(newLi);
                
                // å¦‚æœæœ‰åŸå§‹çš„ä¸Šä¼ å®Œæˆå›è°ƒï¼Œä¹Ÿæ‰§è¡Œå®ƒ
                if (typeof originalUploadComplete === 'function') {
                    originalUploadComplete(attachment);
                }
            };
            
            // é‡å†™æ–‡ä»¶ä¸Šä¼ å¼€å§‹å›è°ƒ
            Typecho.uploadStart = function(file) {
                var fileName = file.name || '';
                
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ä¸Šä¼ ä¸­çŠ¶æ€é¡¹
                var loadingLi = $('<li class="loading"></li>')
                    .attr('id', file.id)
                    .append('<div class="thumb-container"><div class="file-icon">â³</div></div>')
                    .append('<div class="file-info"><div class="file-name">' + fileName + '</div><div class="file-size">ä¸Šä¼ ä¸­...</div></div>')
                    .append('<div class="upload-progress"></div>');
                
                $('#file-list').prepend(loadingLi);
            };
            
            // ç»‘å®šäº‹ä»¶å¤„ç†ç¨‹åº
            $(document).on('click', '.btn-insert', function(e) {
                e.preventDefault();
                e.stopPropagation();
                var $li = $(this).closest('li');
                var title = $li.find('.file-name').text();
                Typecho.insertFileToEditor(title, $li.data('url'), $li.data('image') == 1);
            });
            
            $('#batch-insert').click(function(e) {
                e.preventDefault();
                e.stopPropagation();
                var content = '';
                $('#file-list li').each(function() {
                    if ($(this).find('.file-checkbox').is(':checked')) {
                        var $li = $(this);
                        var title = $li.find('.file-name').text();
                        var url = $li.data('url');
                        var isImage = $li.data('image') == 1;
                        
                        content += isImage ? '![' + title + '](' + url + ')\n' : 
                                           '[' + title + '](' + url + ')\n';
                    }
                });
                
                if (content) {
                    var textarea = $('#text');
                    var pos = textarea.getSelection();
                    var newContent = textarea.val();
                    newContent = newContent.substring(0, pos.start) + content + newContent.substring(pos.end);
                    textarea.val(newContent);
                    textarea.focus();
                }
            });
            
            $('#select-all').click(function(e) {
                e.preventDefault();
                e.stopPropagation();
                $('#file-list .file-checkbox').prop('checked', true);
                return false;
            });
            
            $('#unselect-all').click(function(e) {
                e.preventDefault();
                e.stopPropagation();
                $('#file-list .file-checkbox').prop('checked', false);
                return false;
            });
            
            // é˜²æ­¢å¤é€‰æ¡†ç‚¹å‡»äº‹ä»¶å†’æ³¡
            $(document).on('click', '.file-checkbox', function(e) {
                e.stopPropagation();
            });
            
            // ä¿æŒåŸæœ‰çš„åˆ é™¤åŠŸèƒ½
            $(document).on('click', '.btn-delete', function(e) {
                e.preventDefault();
                e.stopPropagation();
                var $li = $(this).closest('li');
                if (confirm('ç¡®è®¤è¦åˆ é™¤æ–‡ä»¶å—?')) {
                    var cid = $li.data('cid');
                    $.post(window.TypechoComment.url, 
                        {'do': 'delete', 'cid': cid},
                        function() {
                            $li.fadeOut(function() {
                                $(this).remove();
                            });
                        });
                }
            });
            
            // åˆå§‹åŒ–ç°æœ‰æ–‡ä»¶åˆ—è¡¨
            updateFileList();
        });
        </script>
        <?php
    }
}
```